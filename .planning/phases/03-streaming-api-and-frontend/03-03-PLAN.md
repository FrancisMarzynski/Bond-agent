---
phase: 03-streaming-api-and-frontend
plan: 03
type: execute
wave: 2
depends_on:
  - "03-02"
files_modified:
  - frontend/src/app/layout.tsx
  - frontend/src/app/page.tsx
  - frontend/src/components/ModeToggle.tsx
  - frontend/src/components/StageProgress.tsx
  - frontend/src/components/Sidebar.tsx
autonomous: true
requirements:
  - UI-01
  - UI-02

must_haves:
  truths:
    - "A persistent left sidebar shows session history with a New Session button"
    - "The header contains an Author/Shadow mode toggle switch that is always visible"
    - "A stepper component at the top of the main area shows Research → Structure → Writing stages with current stage highlighted"
    - "The overall layout is a three-column structure: sidebar (left), chat+editor area (center), with the header spanning full width"
    - "Switching the mode toggle updates the Zustand store mode field"
    - "The stepper updates visually as stage events arrive from the SSE stream"
  artifacts:
    - path: "frontend/src/app/layout.tsx"
      provides: "Root layout with sidebar, header with ModeToggle, main content area"
      contains: "Sidebar"
    - path: "frontend/src/components/ModeToggle.tsx"
      provides: "Author/Shadow switch in header, reads/writes useChatStore mode"
      exports: ["ModeToggle"]
    - path: "frontend/src/components/StageProgress.tsx"
      provides: "Three-step stepper (Research → Structure → Writing) reflecting store stage state"
      exports: ["StageProgress"]
    - path: "frontend/src/components/Sidebar.tsx"
      provides: "Left sidebar with session list and New Session button"
      exports: ["Sidebar"]
  key_links:
    - from: "frontend/src/components/ModeToggle.tsx"
      to: "frontend/src/store/chatStore.ts"
      via: "useChatStore setMode action"
      pattern: "useChatStore.*setMode"
    - from: "frontend/src/components/StageProgress.tsx"
      to: "frontend/src/store/chatStore.ts"
      via: "useChatStore stage and stageStatus selectors"
      pattern: "useChatStore.*stage"
    - from: "frontend/src/app/layout.tsx"
      to: "frontend/src/components/Sidebar.tsx"
      via: "React import and JSX"
      pattern: "<Sidebar"
---

<objective>
Build the application shell: root layout with sidebar, header with ModeToggle, and the StageProgress stepper component that communicates pipeline progress to the user.

Purpose: These are the structural and navigation components that every view in the app shares. The ModeToggle and StageProgress implement locked UX decisions from CONTEXT.md.
Output: A visually functional app shell — layout with sidebar, header showing Author/Shadow toggle, and a stepper at the top of the main view that reacts to SSE stage events.
</objective>

<execution_context>
@/Users/franciszekmarzynski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/franciszekmarzynski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-streaming-api-and-frontend/03-CONTEXT.md
@.planning/phases/03-streaming-api-and-frontend/03-RESEARCH.md
@.planning/phases/03-streaming-api-and-frontend/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Root layout with sidebar and header</name>
  <files>
    frontend/src/app/layout.tsx
    frontend/src/app/page.tsx
    frontend/src/components/Sidebar.tsx
  </files>
  <action>
Create `frontend/src/components/Sidebar.tsx`:
A fixed-width left sidebar (w-64) showing session history and a "New Session" button. Uses useSession hook for newSession action. Session list is initially empty (sessions loaded from sessionStorage threadId on mount). Uses shadcn `Button` and `Separator` components.

```tsx
"use client";
import { Button } from "@/components/ui/button";
import { Separator } from "@/components/ui/separator";
import { PlusCircle, MessageSquare } from "lucide-react";
import { useSession } from "@/hooks/useSession";
import { useChatStore } from "@/store/chatStore";

export function Sidebar() {
  const { threadId, newSession } = useSession();

  return (
    <aside className="w-64 h-full flex flex-col border-r bg-muted/30 shrink-0">
      <div className="p-4 flex items-center justify-between">
        <span className="font-semibold text-sm">Bond Agent</span>
        <Button variant="ghost" size="sm" onClick={newSession} title="New session">
          <PlusCircle className="h-4 w-4" />
        </Button>
      </div>
      <Separator />
      <nav className="flex-1 overflow-y-auto p-2 space-y-1">
        {threadId ? (
          <div className="flex items-center gap-2 px-2 py-1.5 rounded-md bg-accent text-accent-foreground text-sm">
            <MessageSquare className="h-3.5 w-3.5 shrink-0" />
            <span className="truncate font-mono text-xs">{threadId.slice(0, 12)}…</span>
          </div>
        ) : (
          <p className="text-xs text-muted-foreground px-2 py-4 text-center">
            No active session
          </p>
        )}
      </nav>
    </aside>
  );
}
```

Update `frontend/src/app/layout.tsx` to use a three-panel layout (sidebar left, main right, header spanning full width). Import ModeToggle and Sidebar. Use `"use client"` directive at the file level only if needed — prefer Server Component for layout.

The layout structure (CSS):
- `flex h-screen overflow-hidden` on body/root
- Sidebar: `w-64 h-full shrink-0`
- Main area: `flex-1 flex flex-col min-w-0 overflow-hidden`
  - Header: `h-14 border-b flex items-center px-4 justify-between shrink-0`
  - Content: `flex-1 overflow-hidden`

```tsx
// layout.tsx (Server Component — no "use client")
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import { Sidebar } from "@/components/Sidebar";
import { ModeToggle } from "@/components/ModeToggle";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Bond Agent",
  description: "AI editorial assistant",
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="pl">
      <body className={`${inter.className} flex h-screen overflow-hidden bg-background`}>
        <Sidebar />
        <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
          <header className="h-14 border-b flex items-center px-4 justify-between shrink-0">
            <span className="font-medium text-sm text-muted-foreground">Author Mode</span>
            <ModeToggle />
          </header>
          <main className="flex-1 overflow-hidden">
            {children}
          </main>
        </div>
      </body>
    </html>
  );
}
```

Update `frontend/src/app/page.tsx` to a minimal placeholder (StageProgress + empty chat area):
```tsx
import { StageProgress } from "@/components/StageProgress";

export default function Home() {
  return (
    <div className="flex flex-col h-full">
      <StageProgress />
      <div className="flex-1 p-4 text-muted-foreground text-sm">
        Chat interface coming in Plan 04.
      </div>
    </div>
  );
}
```
  </action>
  <verify>
    cd /Users/franciszekmarzynski/Downloads/Bond-agent/frontend && npx tsc --noEmit 2>&1 | head -10
  </verify>
  <done>Layout renders with sidebar on left, header with ModeToggle on top right, main content area; no TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 2: ModeToggle and StageProgress components</name>
  <files>
    frontend/src/components/ModeToggle.tsx
    frontend/src/components/StageProgress.tsx
  </files>
  <action>
Create `frontend/src/components/ModeToggle.tsx`:
A shadcn `Switch` toggling between Author and Shadow modes. Always visible in the header. Small and not dominant (per locked decision). Shows current mode label.

```tsx
"use client";
import { Switch } from "@/components/ui/switch";
import { useChatStore } from "@/store/chatStore";
import { Badge } from "@/components/ui/badge";

export function ModeToggle() {
  const { mode, setMode } = useChatStore();

  return (
    <div className="flex items-center gap-2">
      <span className="text-xs text-muted-foreground">Author</span>
      <Switch
        checked={mode === "shadow"}
        onCheckedChange={(checked) => setMode(checked ? "shadow" : "author")}
        aria-label="Toggle mode"
      />
      <span className="text-xs text-muted-foreground">Shadow</span>
      <Badge variant={mode === "author" ? "default" : "secondary"} className="text-xs ml-1">
        {mode === "author" ? "Author" : "Shadow"}
      </Badge>
    </div>
  );
}
```

Create `frontend/src/components/StageProgress.tsx`:
A three-step stepper showing Research → Structure → Writing stages. Reads from Zustand `stage` and `stageStatus`. Shows current stage as highlighted/active. Uses shadcn `Progress` as the underlying bar, with custom step labels above.

Stage mapping:
- "research" → step 1 active
- "structure" → step 2 active
- "writing" → step 3 active
- "done" → all complete
- "idle" → no progress shown (hide the component or show at 0%)
- "error" → show error state

```tsx
"use client";
import { useChatStore, type Stage } from "@/store/chatStore";
import { cn } from "@/lib/utils";
import { CheckCircle2, Circle, Loader2 } from "lucide-react";

const STEPS: { id: Stage; label: string }[] = [
  { id: "research", label: "Research" },
  { id: "structure", label: "Structure" },
  { id: "writing", label: "Writing" },
];

function stepIndex(stage: Stage): number {
  return STEPS.findIndex((s) => s.id === stage);
}

export function StageProgress() {
  const { stage, stageStatus, isStreaming } = useChatStore();

  // Only show stepper when a session is active
  if (stage === "idle" && !isStreaming) return null;

  const currentIdx = stepIndex(stage);

  return (
    <div className="border-b px-4 py-3 bg-muted/20">
      <ol className="flex items-center gap-0">
        {STEPS.map((step, idx) => {
          const status = stageStatus[step.id];
          const isActive = step.id === stage;
          const isComplete = status === "complete" || (currentIdx > idx && stage !== "error");
          const isRunning = isActive && status === "running";

          return (
            <li key={step.id} className="flex items-center">
              <span className="flex items-center gap-1.5">
                {isComplete ? (
                  <CheckCircle2 className="h-4 w-4 text-primary" />
                ) : isRunning ? (
                  <Loader2 className="h-4 w-4 text-primary animate-spin" />
                ) : (
                  <Circle className={cn("h-4 w-4", isActive ? "text-primary" : "text-muted-foreground/50")} />
                )}
                <span className={cn(
                  "text-xs font-medium",
                  isActive ? "text-foreground" : isComplete ? "text-foreground/70" : "text-muted-foreground/50"
                )}>
                  {step.label}
                </span>
              </span>
              {idx < STEPS.length - 1 && (
                <span className={cn(
                  "mx-2 h-px w-8",
                  isComplete ? "bg-primary" : "bg-muted-foreground/20"
                )} />
              )}
            </li>
          );
        })}
      </ol>
    </div>
  );
}
```
  </action>
  <verify>
    cd /Users/franciszekmarzynski/Downloads/Bond-agent/frontend && npx tsc --noEmit 2>&1 | head -10 && npm run build 2>&1 | tail -8
  </verify>
  <done>ModeToggle renders a shadcn Switch between Author/Shadow labels; StageProgress renders a three-step stepper that hides when stage=idle; both compile without TypeScript errors; build succeeds</done>
</task>

</tasks>

<verification>
1. `npm run dev` in frontend/ — app loads at localhost:3000 without runtime errors
2. Sidebar is visible on the left with "Bond Agent" label and + button
3. Header shows "Author Mode" label and ModeToggle switch on the right
4. Clicking ModeToggle switches between Author/Shadow and updates Badge label
5. StageProgress is hidden at initial load (stage=idle), then appears when stage changes
6. `npm run build` succeeds with no errors
</verification>

<success_criteria>
- Root layout: three-column structure (sidebar 256px | main area flex-1) with full-width header
- Sidebar shows current session threadId (first 12 chars) or "No active session" placeholder
- ModeToggle: shadcn Switch + two text labels + Badge showing current mode; updates Zustand on toggle
- StageProgress: 3-step stepper (Research → Structure → Writing); hidden when stage=idle; running step shows spinner; complete step shows checkmark; transitions reflect store stageStatus
- TypeScript strict-mode compile passes; build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-streaming-api-and-frontend/03-03-SUMMARY.md`
</output>
