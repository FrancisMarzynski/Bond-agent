---
phase: 03-streaming-api-and-frontend
plan: 05
type: execute
wave: 3
depends_on:
  - "03-03"
  - "03-04"
files_modified:
  - frontend/src/app/corpus/page.tsx
  - frontend/src/components/corpus/CorpusStatus.tsx
  - frontend/src/components/corpus/IngestionForm.tsx
autonomous: false
requirements:
  - UI-08

must_haves:
  truths:
    - "A /corpus route exists and is accessible from a link in the sidebar"
    - "The corpus page shows article count, chunk count, and a low-corpus warning when article_count < 10"
    - "Four stacked ingestion cards are present: paste text, file upload, Google Drive folder, blog URL"
    - "Each card has its own submit action; submission shows a spinner within that card, then a success or error state"
    - "Source label (own text / external blogger) can be selected per submission"
    - "Article count and chunk count are fetched from GET /api/corpus/status on page load"
  artifacts:
    - path: "frontend/src/app/corpus/page.tsx"
      provides: "Corpus management route — composes CorpusStatus and IngestionForm"
      contains: "CorpusStatus"
    - path: "frontend/src/components/corpus/CorpusStatus.tsx"
      provides: "Fetches /api/corpus/status; renders article count, chunk count, low-corpus warning badge"
      exports: ["CorpusStatus"]
    - path: "frontend/src/components/corpus/IngestionForm.tsx"
      provides: "Four stacked card sections for all ingestion types; inline feedback per card"
      exports: ["IngestionForm"]
  key_links:
    - from: "frontend/src/components/corpus/CorpusStatus.tsx"
      to: "http://localhost:8000/api/corpus/status"
      via: "fetch GET on mount"
      pattern: "fetch.*corpus/status"
    - from: "frontend/src/components/corpus/IngestionForm.tsx"
      to: "http://localhost:8000/api/corpus/ingest"
      via: "fetch POST multipart form"
      pattern: "fetch.*corpus/ingest"
    - from: "frontend/src/app/layout.tsx"
      to: "frontend/src/app/corpus/page.tsx"
      via: "Next.js Link in Sidebar"
      pattern: "href.*corpus"
---

<objective>
Build the corpus management section: a dedicated /corpus page with live status display and four-input ingestion form (paste, file, Google Drive, blog URL), each with inline feedback.

Purpose: Fulfills UI-08 (corpus access from the UI), using the FastAPI corpus endpoints from Plan 01.
Output: A functional /corpus page reachable from the sidebar, with working status display and form submissions wired to the backend.
</objective>

<execution_context>
@/Users/franciszekmarzynski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/franciszekmarzynski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-streaming-api-and-frontend/03-CONTEXT.md
@.planning/phases/03-streaming-api-and-frontend/03-RESEARCH.md
@.planning/phases/03-streaming-api-and-frontend/03-03-SUMMARY.md
@.planning/phases/03-streaming-api-and-frontend/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: CorpusStatus and IngestionForm components</name>
  <files>
    frontend/src/components/corpus/CorpusStatus.tsx
    frontend/src/components/corpus/IngestionForm.tsx
  </files>
  <action>
Create `frontend/src/components/corpus/CorpusStatus.tsx`:
Fetches `GET /api/corpus/status` on mount. Displays article count, chunk count, and a warning badge if article_count < 10. Uses shadcn `Badge` and `Card`.

```tsx
"use client";
import { useEffect, useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { AlertTriangle, BookOpen, Layers } from "lucide-react";

const API_URL = process.env.NEXT_PUBLIC_API_URL ?? "http://localhost:8000";

interface CorpusStatusData {
  article_count: number;
  chunk_count: number;
  low_corpus_warning: boolean;
}

export function CorpusStatus() {
  const [status, setStatus] = useState<CorpusStatusData | null>(null);
  const [loading, setLoading] = useState(true);

  const refresh = async () => {
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/api/corpus/status`);
      if (res.ok) setStatus(await res.json());
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { refresh(); }, []);

  return (
    <Card>
      <CardHeader className="pb-2">
        <CardTitle className="text-sm font-medium flex items-center gap-2">
          Corpus Status
          {status?.low_corpus_warning && (
            <Badge variant="destructive" className="text-xs gap-1">
              <AlertTriangle className="h-3 w-3" />
              Low corpus (&lt;10 articles)
            </Badge>
          )}
        </CardTitle>
      </CardHeader>
      <CardContent>
        {loading ? (
          <p className="text-xs text-muted-foreground">Loading…</p>
        ) : status ? (
          <div className="flex gap-6">
            <div className="flex items-center gap-1.5 text-sm">
              <BookOpen className="h-4 w-4 text-muted-foreground" />
              <span className="font-semibold">{status.article_count}</span>
              <span className="text-muted-foreground text-xs">articles</span>
            </div>
            <div className="flex items-center gap-1.5 text-sm">
              <Layers className="h-4 w-4 text-muted-foreground" />
              <span className="font-semibold">{status.chunk_count}</span>
              <span className="text-muted-foreground text-xs">chunks</span>
            </div>
          </div>
        ) : (
          <p className="text-xs text-destructive">Could not load status</p>
        )}
      </CardContent>
    </Card>
  );
}
```

Create `frontend/src/components/corpus/IngestionForm.tsx`:
Four stacked card sections (per locked decision). Each card has its own state: idle → submitting (spinner) → success/error (inline feedback). Source label selector (own / external) on each card.

```tsx
"use client";
import { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Loader2, CheckCircle2, XCircle, Type, FileUp, FolderOpen, Globe } from "lucide-react";
import { cn } from "@/lib/utils";

const API_URL = process.env.NEXT_PUBLIC_API_URL ?? "http://localhost:8000";

type CardState = "idle" | "loading" | "success" | "error";

function SourceLabelSelect({ value, onChange }: { value: string; onChange: (v: string) => void }) {
  return (
    <div className="flex gap-2 items-center text-xs">
      <span className="text-muted-foreground">Source:</span>
      {["own", "external"].map((label) => (
        <button
          key={label}
          type="button"
          onClick={() => onChange(label)}
          className={cn(
            "px-2 py-0.5 rounded border text-xs transition-colors",
            value === label
              ? "bg-primary text-primary-foreground border-primary"
              : "border-input hover:bg-muted"
          )}
        >
          {label === "own" ? "Own text" : "External blogger"}
        </button>
      ))}
    </div>
  );
}

async function submitIngest(formData: FormData): Promise<{ ok: boolean; message: string }> {
  const res = await fetch(`${API_URL}/api/corpus/ingest`, {
    method: "POST",
    body: formData,
  });
  const json = await res.json();
  if (res.ok && json.status !== "error") {
    return { ok: true, message: json.message ?? "Successfully added to corpus" };
  }
  return { ok: false, message: json.detail ?? json.message ?? "Ingestion failed" };
}

function FeedbackBadge({ state, message }: { state: CardState; message: string }) {
  if (state === "loading") return <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />;
  if (state === "success") return (
    <span className="flex items-center gap-1 text-xs text-green-600">
      <CheckCircle2 className="h-3.5 w-3.5" /> {message}
    </span>
  );
  if (state === "error") return (
    <span className="flex items-center gap-1 text-xs text-destructive">
      <XCircle className="h-3.5 w-3.5" /> {message}
    </span>
  );
  return null;
}

export function IngestionForm() {
  // Paste text card
  const [pasteText, setPasteText] = useState("");
  const [pasteLabel, setPasteLabel] = useState("own");
  const [pasteState, setPasteState] = useState<CardState>("idle");
  const [pasteMsg, setPasteMsg] = useState("");

  // File upload card
  const [file, setFile] = useState<File | null>(null);
  const [fileLabel, setFileLabel] = useState("own");
  const [fileState, setFileState] = useState<CardState>("idle");
  const [fileMsg, setFileMsg] = useState("");

  // Google Drive card
  const [driveId, setDriveId] = useState("");
  const [driveLabel, setDriveLabel] = useState("own");
  const [driveState, setDriveState] = useState<CardState>("idle");
  const [driveMsg, setDriveMsg] = useState("");

  // Blog URL card
  const [blogUrl, setBlogUrl] = useState("");
  const [blogLabel, setBlogLabel] = useState("external");
  const [blogState, setBlogState] = useState<CardState>("idle");
  const [blogMsg, setBlogMsg] = useState("");

  const handlePaste = async () => {
    if (!pasteText.trim()) return;
    setPasteState("loading");
    const fd = new FormData();
    fd.append("source_type", "text");
    fd.append("text", pasteText);
    fd.append("source_label", pasteLabel);
    const result = await submitIngest(fd);
    setPasteState(result.ok ? "success" : "error");
    setPasteMsg(result.message);
    if (result.ok) setPasteText("");
  };

  const handleFile = async () => {
    if (!file) return;
    setFileState("loading");
    const fd = new FormData();
    fd.append("source_type", "file");
    fd.append("file", file);
    fd.append("source_label", fileLabel);
    const result = await submitIngest(fd);
    setFileState(result.ok ? "success" : "error");
    setFileMsg(result.message);
    if (result.ok) setFile(null);
  };

  const handleDrive = async () => {
    if (!driveId.trim()) return;
    setDriveState("loading");
    const fd = new FormData();
    fd.append("source_type", "gdrive");
    fd.append("gdrive_folder_id", driveId);
    fd.append("source_label", driveLabel);
    const result = await submitIngest(fd);
    setDriveState(result.ok ? "success" : "error");
    setDriveMsg(result.message);
    if (result.ok) setDriveId("");
  };

  const handleBlog = async () => {
    if (!blogUrl.trim()) return;
    setBlogState("loading");
    const fd = new FormData();
    fd.append("source_type", "url");
    fd.append("blog_url", blogUrl);
    fd.append("source_label", blogLabel);
    const result = await submitIngest(fd);
    setBlogState(result.ok ? "success" : "error");
    setBlogMsg(result.message);
    if (result.ok) setBlogUrl("");
  };

  return (
    <div className="space-y-4">
      {/* 1. Paste text */}
      <Card>
        <CardHeader className="pb-2">
          <CardTitle className="text-sm flex items-center gap-2">
            <Type className="h-4 w-4" /> Paste Text
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          <Textarea
            value={pasteText}
            onChange={(e) => setPasteText(e.target.value)}
            placeholder="Paste article text here…"
            rows={4}
            disabled={pasteState === "loading"}
          />
          <div className="flex items-center justify-between">
            <SourceLabelSelect value={pasteLabel} onChange={setPasteLabel} />
            <div className="flex items-center gap-2">
              <FeedbackBadge state={pasteState} message={pasteMsg} />
              <Button size="sm" onClick={handlePaste} disabled={!pasteText.trim() || pasteState === "loading"}>
                Add
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* 2. File upload */}
      <Card>
        <CardHeader className="pb-2">
          <CardTitle className="text-sm flex items-center gap-2">
            <FileUp className="h-4 w-4" /> Upload File
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          <Input
            type="file"
            accept=".pdf,.docx,.txt"
            onChange={(e) => setFile(e.target.files?.[0] ?? null)}
            disabled={fileState === "loading"}
          />
          <div className="flex items-center justify-between">
            <SourceLabelSelect value={fileLabel} onChange={setFileLabel} />
            <div className="flex items-center gap-2">
              <FeedbackBadge state={fileState} message={fileMsg} />
              <Button size="sm" onClick={handleFile} disabled={!file || fileState === "loading"}>
                Upload
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* 3. Google Drive */}
      <Card>
        <CardHeader className="pb-2">
          <CardTitle className="text-sm flex items-center gap-2">
            <FolderOpen className="h-4 w-4" /> Google Drive Folder
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          <Input
            value={driveId}
            onChange={(e) => setDriveId(e.target.value)}
            placeholder="Google Drive folder ID…"
            disabled={driveState === "loading"}
          />
          <div className="flex items-center justify-between">
            <SourceLabelSelect value={driveLabel} onChange={setDriveLabel} />
            <div className="flex items-center gap-2">
              <FeedbackBadge state={driveState} message={driveMsg} />
              <Button size="sm" onClick={handleDrive} disabled={!driveId.trim() || driveState === "loading"}>
                Import
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* 4. Blog URL */}
      <Card>
        <CardHeader className="pb-2">
          <CardTitle className="text-sm flex items-center gap-2">
            <Globe className="h-4 w-4" /> Blog URL
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          <Input
            type="url"
            value={blogUrl}
            onChange={(e) => setBlogUrl(e.target.value)}
            placeholder="https://example.com/blog"
            disabled={blogState === "loading"}
          />
          <div className="flex items-center justify-between">
            <SourceLabelSelect value={blogLabel} onChange={setBlogLabel} />
            <div className="flex items-center gap-2">
              <FeedbackBadge state={blogState} message={blogMsg} />
              <Button size="sm" onClick={handleBlog} disabled={!blogUrl.trim() || blogState === "loading"}>
                Scrape
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```
  </action>
  <verify>
    cd /Users/franciszekmarzynski/Downloads/Bond-agent/frontend && npx tsc --noEmit 2>&1 | grep "corpus" | head -10
  </verify>
  <done>Both corpus components compile without TypeScript errors; CorpusStatus fetches /api/corpus/status on mount; IngestionForm has four distinct card sections each with independent state and inline feedback</done>
</task>

<task type="auto">
  <name>Task 2: Corpus page route and sidebar navigation link</name>
  <files>
    frontend/src/app/corpus/page.tsx
    frontend/src/components/Sidebar.tsx
  </files>
  <action>
Create `frontend/src/app/corpus/page.tsx`:
```tsx
import { CorpusStatus } from "@/components/corpus/CorpusStatus";
import { IngestionForm } from "@/components/corpus/IngestionForm";

export default function CorpusPage() {
  return (
    <div className="max-w-2xl mx-auto p-6 space-y-6">
      <div>
        <h1 className="text-lg font-semibold">Corpus Management</h1>
        <p className="text-sm text-muted-foreground mt-1">
          Add articles to the style corpus used for draft generation.
        </p>
      </div>
      <CorpusStatus />
      <div>
        <h2 className="text-sm font-medium mb-3">Add Content</h2>
        <IngestionForm />
      </div>
    </div>
  );
}
```

Update `frontend/src/components/Sidebar.tsx` to add a navigation link to /corpus using Next.js `Link`. Add it below the session list section. Use a `Database` icon from lucide-react.

Import `Link` from `next/link` and add:
```tsx
import Link from "next/link";
import { Database } from "lucide-react";

// Inside Sidebar, below the <nav> session section, add:
<div className="p-2 border-t">
  <Link
    href="/corpus"
    className="flex items-center gap-2 px-2 py-1.5 rounded-md text-sm hover:bg-accent text-muted-foreground hover:text-accent-foreground transition-colors"
  >
    <Database className="h-4 w-4" />
    Corpus
  </Link>
</div>
```
  </action>
  <verify>
    cd /Users/franciszekmarzynski/Downloads/Bond-agent/frontend && npx tsc --noEmit 2>&1 | head -10 && npm run build 2>&1 | tail -8
  </verify>
  <done>/corpus route exists at frontend/src/app/corpus/page.tsx; Sidebar contains a Link to /corpus with Database icon; TypeScript and build both pass</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of complete Phase 3 UI</name>
  <action>Start FastAPI and Next.js dev servers, then verify all UI-01 through UI-08 requirements are visually present and interactive per the steps below.</action>
  <what-built>
    Complete Phase 3 implementation:
    - FastAPI backend with SSE streaming, HITL resume, corpus endpoints (Plan 01)
    - Next.js 15 frontend with Zustand store, SSE hooks, session persistence (Plan 02)
    - App layout with sidebar, header ModeToggle, StageProgress stepper (Plan 03)
    - ChatInterface, EditorPane, CheckpointPanel with full streaming + HITL UI (Plan 04)
    - Corpus management page with CorpusStatus and four-input IngestionForm (this plan)
  </what-built>
  <how-to-verify>
    **Start services:**
    ```bash
    # Terminal 1 — FastAPI backend
    cd /Users/franciszekmarzynski/Downloads/Bond-agent
    uvicorn backend.main:app --reload --port 8000

    # Terminal 2 — Next.js frontend
    cd /Users/franciszekmarzynski/Downloads/Bond-agent/frontend
    npm run dev
    ```

    **Check 1 — Layout (UI-01):**
    1. Open http://localhost:3000
    2. Verify: sidebar on left, header on top, Author/Shadow toggle switch visible in header
    3. Click the toggle — verify the mode badge changes between Author/Shadow

    **Check 2 — StageProgress (UI-02):**
    4. Open browser console and run: `window.dispatchEvent(new Event('test'))` (no-op, just to confirm console works)
    5. The stepper should be hidden at initial load (stage = idle)

    **Check 3 — Corpus management (UI-08):**
    6. Click "Corpus" in the sidebar
    7. Verify: /corpus page loads; Corpus Status card shows article count and chunk count; low-corpus warning badge is visible if backend returns article_count < 10
    8. Verify: four stacked cards are visible (Paste Text, Upload File, Google Drive Folder, Blog URL)
    9. Try submitting an empty paste text — the Add button should remain disabled

    **Check 4 — Chat interface (UI-07):**
    10. Navigate back to http://localhost:3000
    11. Type "Test topic about AI" in the chat input, press Enter
    12. Verify: message appears in chat list; streaming state begins (send button shows spinner)
    13. Verify: FastAPI server log shows a request to /api/chat/stream

    **Check 5 — Editor pane (UI-03):**
    14. Verify: editor pane shows placeholder text when no draft; if streaming is happening and draft tokens are received, the @uiw/react-md-editor appears with live preview

    **Check 6 — Checkpoint panel (UI-04, UI-05, UI-06):**
    15. Open browser console and run:
        ```js
        const {useChatStore} = await import('/src/store/chatStore.ts');
        // If direct import fails, find the store via __NEXT_DATA__ or React DevTools
        ```
        Alternatively, use React DevTools to manually set hitlPause state.
    16. Verify: CheckpointPanel appears with Approve and Reject buttons when hitlPause is set
    17. Verify: Approve+Save button is visible only for checkpoint_id containing "cp2" or "checkpoint_2"

    **Check 7 — Backend health:**
    18. `curl http://localhost:8000/health` → `{"status": "ok"}`
    19. `curl http://localhost:8000/api/corpus/status` → JSON with article_count
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe specific issues found (e.g. "sidebar link missing", "editor not rendering")</resume-signal>
</task>

</tasks>

<verification>
1. Both servers start without errors
2. Layout visible: sidebar, header with ModeToggle, main content area
3. Corpus page accessible from sidebar with status and four ingestion cards
4. Chat input triggers SSE stream to FastAPI
5. CheckpointPanel responds to hitlPause store state
6. npm run build passes
</verification>

<success_criteria>
- /corpus route renders CorpusStatus + IngestionForm
- CorpusStatus: fetches /api/corpus/status, displays article_count and chunk_count, shows destructive Badge when low_corpus_warning is true
- IngestionForm: four stacked shadcn Card sections; each has its own loading/success/error state; inline FeedbackBadge renders correctly per state; source label selector (own/external) on each card
- Sidebar contains a Link to /corpus with Database icon
- Human verification confirms all UI-01 through UI-08 requirements are visually present and interactive
</success_criteria>

<output>
After completion, create `.planning/phases/03-streaming-api-and-frontend/03-05-SUMMARY.md`
</output>
